<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Ø¯ÙƒØ§Ù† Ø§Ù„Ø­Ø¬ÙˆØ±' %></title>
    <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">
</head>
<body data-theme="light">

    <header>
        <div class="header-content">
            <a href="/" class="logo">
                <img src="/logo.png" alt="Ø´Ø¹Ø§Ø± Ø¯ÙƒØ§Ù† Ø§Ù„Ø­Ø¬ÙˆØ±" class="logo-img">
                <span class="logo-text">Ø¯ÙƒØ§Ù† Ø§Ù„Ø­Ø¬ÙˆØ±</span>
            </a>
            
            <nav class="main-nav" id="mainNav">
                <ul class="nav-links desktop-links" style="list-style: none; margin: 0; padding: 0; display: flex; gap: 1rem; align-items: center;">
    
                    <!-- ======== Ø¨Ø¯Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ ======== -->
                    <!-- Ø±ÙˆØ§Ø¨Ø· Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ -->
                    <li><a href="/" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li><a href="/market" class="nav-link">ğŸ›ï¸ ØªØµÙØ­ Ø§Ù„Ø³ÙˆÙ‚</a></li>
<li><a href="/dukkanlar" class="nav-link">ğŸª Ø§Ù„Ø¯ÙƒØ§ÙƒÙŠÙ†</a></li>

                    <% if (typeof user !== 'undefined' && user && user.id) { %>
                        <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ -->
                        <li><a href="/my-products" class="nav-link">Ù…Ù†ØªØ¬Ø§ØªÙŠ</a></li>
                        <li><a href="/add-product" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</a></li>
                        
                        <% if (user.is_admin) { %>
                            <li><a href="/admin" class="nav-link admin-link-header">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                        <% } %>

                        <li class="user-info-desktop">
                            <a href="/profile" class="user-profile-link" style="text-decoration: none; display: flex; align-items: center; gap: 0.75rem;">
                                <div class="user-avatar-desktop">
                                    <% if (user.avatar) { %>
                                        <img src="/uploads/<%= user.avatar %>" alt="ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©">
                                    <% } else { %>
                                        <%= user.name.charAt(0).toUpperCase() %>
                                    <% } %>
                                </div>
                                <span class="user-name-desktop"><%= user.name %></span>
                                <% if (user.is_admin) { %>
                                    <span class="admin-badge" title="Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…">ğŸ‘‘</span>
                                <% } %>
                            </a>
                        </li>
                        <li><a href="/logout" class="nav-link logout-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
                    <% } else { %>
                        <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø²Ø§Ø¦Ø± -->
                        <li><a href="/login" class="nav-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></li>
                        <li><a href="/register" class="btn btn-secondary">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></li>
                    <% } %>
                    <!-- ======== Ù†Ù‡Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ ======== -->
                </ul>
            </nav>

            <div class="header-controls" style="display: flex; align-items: center; gap: 1rem;">
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">
                    <span class="theme-icon">ğŸŒ™</span>
                </button>
                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <div class="vision-banner">
        <div class="container">
            <p class="vision-text">ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠ</p>
        </div>
    </div>

    <!-- Mobile slide-out menu -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
    <div class="mobile-nav" id="mobileNav">
        <button class="nav-close" id="navClose">&times;</button>
        <ul class="nav-links">
            <!-- ======== Ø¨Ø¯Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø§ØªÙ ======== -->
            <li><a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
<li><a href="/market">ğŸ›ï¸ ØªØµÙØ­ Ø§Ù„Ø³ÙˆÙ‚</a></li>
<li><a href="/dukkanlar">ğŸª Ø§Ù„Ø¯ÙƒØ§ÙƒÙŠÙ†</a></li>
             <% if (typeof user !== 'undefined' && user && user.id) { %>
                <li><a href="/add-product">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</a></li>
                <li><a href="/my-products">Ù…Ù†ØªØ¬Ø§ØªÙŠ</a></li>
                <li><a href="/profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a></li
                <% if (user.is_admin) { %>
                    <li><a href="/admin" style="color: var(--warning-color);">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                <% } %>
                <hr style="border-color: rgba(128,128,128,0.2); margin: 1rem 0;">
                <li><a href="/logout" style="color: var(--error-color);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            <% } else { %>
                <li><a href="/login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></li>
                <li><a href="/register">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></li>
            <% } %>
            <!-- ======== Ù†Ù‡Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø§ØªÙ ======== -->
        </ul>
    </div>

    <main>
        <div class="container">
            <%- body %>
        </div>
    </main>

    <footer>
        <p>&copy; <%= new Date().getFullYear() %> Ø¯ÙƒØ§Ù† Ø§Ù„Ø­Ø¬ÙˆØ± - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </footer>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
    </div>

   <script>
    // =========================================================================
    // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª)
    // =========================================================================

    /**
     * ØªØ¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ©.
     */
    function showLoadingOverlay() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('visible');
        }
    }

    /**
     * ØªÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨.
     * @param {string} youtubeLink - Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
     */
    // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© openVideoModal Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
// --- Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ---
function openVideoModal(youtubeLink) {
    let videoId = null;
    
    // Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠ Ø§Ù„Ø°ÙƒÙŠ ÙŠØ¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙŠØº Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    // (watch?v=, shorts/, youtu.be/, /embed/)
    const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|embed|shorts)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = youtubeLink.match(youtubeRegex);

    if (match && match[1]) {
        videoId = match[1];
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø¨Ø¹Ø¯ ÙƒÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø­Ø«ØŒ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­
    if (!videoId) {
        alert('Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….');
        console.error('Could not extract YouTube video ID from:', youtubeLink);
        return;
    }

    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

    // ... Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'video-modal-overlay';
    modalOverlay.innerHTML = `
        <div class="video-modal-content">
            <button class="video-modal-close-btn" onclick="closeVideoModal()">Ã—</button>
            <div class="video-wrapper">
                <iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    `;
    document.body.appendChild(modalOverlay);
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeVideoModal();
    });
}


    /**
     * ØªØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.
     */
    function closeVideoModal() {
        const modalOverlay = document.querySelector('.video-modal-overlay');
        if (modalOverlay) {
            document.body.removeChild(modalOverlay);
        }
    }
    
    
    // ======== Ø¨Ø¯Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ========
    /**
     * ØªÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø´ÙƒÙ„ Ø£ÙƒØ¨Ø±.
     * @param {string} imageSrc - Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©.
     * @param {string} productName - Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù„Ù„Ù†Øµ Ø§Ù„Ø¨Ø¯ÙŠÙ„).
     */
    function openImageModal(imageSrc, productName) {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'image-modal-overlay';
        modalOverlay.innerHTML = `
            <div class="image-modal-content">
                <button class="image-modal-close-btn" onclick="closeImageModal()">Ã—</button>
                <img src="${imageSrc}" alt="${productName}">
            </div>
        `;
        document.body.appendChild(modalOverlay);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeImageModal();
        });
    }

    /**
     * ØªØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±.
     */
    function closeImageModal() {
        const modalOverlay = document.querySelector('.image-modal-overlay');
        if (modalOverlay) {
            document.body.removeChild(modalOverlay);
        }
    }
    // ======== Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ========
    
// --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ (Event Delegation) ---
document.body.addEventListener('click', function(event) {

    // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ù†Ù‚ÙˆØ± Ø¹Ù„ÙŠÙ‡ (Ø£Ùˆ Ø£Ø­Ø¯ Ø¢Ø¨Ø§Ø¦Ù‡) Ù‡Ùˆ Ø²Ø± ÙÙŠØ¯ÙŠÙˆ
    const videoButton = event.target.closest('.video-btn');
    if (videoButton) {
        const link = videoButton.getAttribute('data-video-link');
        if (link) {
            openVideoModal(link);
        }
    }
             // ======== Ø¨Ø¯Ø§ÙŠØ© Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„ØµÙˆØ± ========
            // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ù†Ù‚ÙˆØ± Ø¹Ù„ÙŠÙ‡ Ù‡Ùˆ ØµÙˆØ±Ø© Ù…Ù†ØªØ¬ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ±
            const zoomableImage = event.target.closest('.product-image-zoomable');
            if (zoomableImage) {
                const imageSrc = zoomableImage.getAttribute('src');
                const productName = zoomableImage.getAttribute('alt');
                if (imageSrc) {
                    openImageModal(imageSrc, productName);
                }
            }
            // ======== Ù†Ù‡Ø§ÙŠØ© Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„ØµÙˆØ± =======
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† "Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†" Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
    // const anotherButton = event.target.closest('.another-class');
    // if (anotherButton) { ... }
});

    // =========================================================================
    // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    // =========================================================================
    document.addEventListener('DOMContentLoaded', function() {

        // --- ÙˆØ¸Ø§Ø¦Ù ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… ---
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const themeIcon = themeToggle.querySelector('.theme-icon');
            const currentTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', currentTheme);
            themeIcon.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

            window.toggleTheme = function() {
                let theme = document.body.getAttribute('data-theme');
                if (theme === 'dark') {
                    theme = 'light';
                    themeIcon.textContent = 'ğŸŒ™';
                } else {
                    theme = 'dark';
                    themeIcon.textContent = 'â˜€ï¸';
                }
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ù‡Ø§ØªÙ ---
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mobileNav = document.getElementById('mobileNav');
        const mobileNavOverlay = document.getElementById('mobileNavOverlay');
        const navClose = document.getElementById('navClose');

        if (mobileMenuToggle && mobileNav && mobileNavOverlay && navClose) {
            function openNav() {
                mobileNav.classList.add('open');
                mobileNavOverlay.classList.add('open');
            }

            function closeNav() {
                mobileNav.classList.remove('open');
                mobileNavOverlay.classList.remove('open');
            }

            mobileMenuToggle.addEventListener('click', openNav);
            navClose.addEventListener('click', closeNav);
            mobileNavOverlay.addEventListener('click', closeNav);
        }
    });
</script>
</body>
</html>