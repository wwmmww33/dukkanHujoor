<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --primary: #2c3e50; 
            --secondary: #27ae60; 
            --danger: #c0392b; 
            --light: #f8f9fa; 
            --border: #dee2e6; 
            --bg: #f8f9fa; 
            --surface: #ffffff; 
            --text: #333333; 
            --text-muted: #666666;
            --table-header: #f8f9fa; 
            --table-stripe: #f9fafb;
            --table-hover: #e9ecef;
            --input-bg: #ffffff;
            --input-text: #333333;
            --purple: #8e44ad;
            --bg-soft-primary: #eaf2f8;
            --bg-soft-success: #e8f5e9;
            --bg-soft-danger: #fdeaea;
            --bg-soft-warning: #fff3cd;
            --text-warning: #856404;
            --text-success-dark: #155724;
        }
        [data-theme="dark"] { 
            --primary: #3f9eff; 
            --secondary: #34c759; 
            --danger: #ff453a; 
            --light: #121212; 
            --border: #3a3a3c; 
            --bg: #121212; 
            --surface: #1e1e1e; 
            --text: #e5e5e5; 
            --text-muted: #a0a0a0;
            --table-header: #2c2c2e; 
            --table-stripe: #252527;
            --table-hover: #3a3a3c;
            --input-bg: #2c2c2e;
            --input-text: #e5e5e5;
            --purple: #bf5af2;
            --bg-soft-primary: rgba(63, 158, 255, 0.15);
            --bg-soft-success: rgba(52, 199, 89, 0.15);
            --bg-soft-danger: rgba(255, 69, 58, 0.15);
            --bg-soft-warning: rgba(255, 214, 10, 0.15);
            --text-warning: #ffd60a;
            --text-success-dark: #63e6be;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .text-success { color: var(--secondary) !important; }
        .text-danger { color: var(--danger) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .text-primary { color: var(--primary) !important; }
        .bg-soft-success { background-color: var(--bg-soft-success) !important; }
        .bg-soft-danger { background-color: var(--bg-soft-danger) !important; }
        .bg-soft-warning { background-color: var(--bg-soft-warning) !important; }
        .text-success-dark { color: var(--text-success-dark) !important; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--surface); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-family: inherit; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; transition: background-color .2s ease, box-shadow .2s ease, color .2s ease; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { border: 1px solid var(--border); background: var(--surface); color: var(--text-muted); }
        .btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .btn-success:hover { background: #1f8f50; }
        .btn-danger:hover { background: #a83224; }
        .btn-outline:hover { background: var(--table-hover); color: var(--text); }
        .btn i { margin-left: 8px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .export-actions { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0 16px; width: 100%; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; touch-action: pan-x; flex-wrap: nowrap; align-items: flex-end; }
        .tab-btn { padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 1rem; color: var(--text-muted); flex: 0 0 auto; white-space: nowrap; }
        .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn i { margin-left: 8px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border); }
        th { background: var(--table-header); color: var(--primary); }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text); }
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; background-color: var(--input-bg); color: var(--input-text); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 8px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; color: var(--text); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close { cursor: pointer; font-size: 1.5rem; color: var(--text-muted); }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: white; }
        .badge.success { background: var(--secondary); }
        .badge.danger { background: var(--danger); }

        textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; resize: vertical; min-height: 80px; background-color: var(--input-bg); color: var(--input-text); }
        
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input { width: auto; }

        .btn-outline.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; max-width: 100%; -webkit-overflow-scrolling: touch; touch-action: pan-x; }
        .table-container table { min-width: auto; }
        @media (max-width: 600px) {
            header { flex-direction: column; align-items: stretch; gap: 12px; }
            .header-actions { width: 100%; flex-wrap: wrap; gap: 10px; }
            .header-actions .btn { flex: 1 1 calc(33.333% - 10px); min-width: 0; }
            .export-actions .btn { flex: 1 1 calc(50% - 10px); }
            th, td { padding: 10px; }
            .tab-btn { padding: 8px 12px; font-size: 0.95rem; }
            .tab-btn i { font-size: 0.95em; }
        }
        @media (max-width: 380px) {
            .header-actions .btn { flex: 1 1 100%; }
            .export-actions .btn { flex: 1 1 100%; }
        }
        .table-fit { table-layout: fixed; width: 100%; }
        .table-fit th, .table-fit td { white-space: normal; vertical-align: middle; }
        
        .transactions-table { min-width: 1200px; }
        .transactions-table th:nth-child(1), .transactions-table td:nth-child(1) { width: 50px; text-align: center; padding: 5px; }
        .transactions-table th:nth-child(2), .transactions-table td:nth-child(2) { width: 120px; white-space: nowrap; }
        .transactions-table th:nth-child(3), .transactions-table td:nth-child(3) { width: 150px; overflow-wrap: break-word; }
        .transactions-table th:nth-child(4), .transactions-table td:nth-child(4) { width: 160px; overflow-wrap: break-word; }
        .transactions-table th:nth-child(5), .transactions-table td:nth-child(5) { width: 120px; white-space: nowrap; }
        .transactions-table th:nth-child(6), .transactions-table td:nth-child(6) { width: 140px; white-space: nowrap; }
        .transactions-table th:nth-child(7), .transactions-table td:nth-child(7) { width: 250px; overflow-wrap: break-word; }
        .transactions-table th:nth-child(8), .transactions-table td:nth-child(8) { width: 180px; white-space: nowrap; }
        
        .members-table { min-width: 1400px; }
        .members-table.compact { min-width: 1100px; }
        .members-table .col-code { width: 80px; white-space: nowrap; }
        .members-table .col-nick { width: 120px; overflow-wrap: break-word; }
        .members-table .col-name { width: 180px; overflow-wrap: break-word; }
        .members-table .col-phone { width: 120px; white-space: nowrap; }
        .members-table .col-email { width: 220px; overflow-wrap: break-word; }
        .members-table .col-pass { width: 100px; white-space: nowrap; }
        .members-table .col-status { width: 90px; white-space: nowrap; }
        .members-table .col-notes { width: auto; overflow-wrap: break-word; min-width: 200px; }
        .members-table .col-actions { width: 350px; white-space: nowrap; }
        .members-table th.sortable { cursor: pointer; }
        .members-table th .sort-icon { margin-left: 6px; color: #999; }
        .members-table th.active .sort-icon { color: var(--secondary); }
        
        .subjects-table { min-width: 700px; }
        .subjects-table th:nth-child(1), .subjects-table td:nth-child(1) { width: 50px; text-align: center; padding: 5px; }
        .subjects-table th:nth-child(2), .subjects-table td:nth-child(2) { width: 450px; overflow-wrap: break-word; }
        .subjects-table th:nth-child(3), .subjects-table td:nth-child(3) { width: 200px; white-space: nowrap; text-align: center; }
        
        .unpaid-table { min-width: 800px; }
        .unpaid-table th:nth-child(1), .unpaid-table td:nth-child(1) { width: 240px; overflow-wrap: break-word; }
        .unpaid-table th:nth-child(2), .unpaid-table td:nth-child(2) { width: 130px; white-space: nowrap; }
        .unpaid-table th:nth-child(3), .unpaid-table td:nth-child(3) { width: 180px; white-space: nowrap; }
        .unpaid-table td.unpaid-name { width: 240px; overflow-wrap: break-word; }
        .unpaid-table .primary-name { font-weight: bold; }
        .unpaid-table .full-name { margin-top: 4px; }

        /* Alternating row colors */
        .transactions-table tbody tr:nth-child(even),
        .members-table tbody tr:nth-child(even),
        .unpaid-table tbody tr:nth-child(even),
        .subjects-table tbody tr:nth-child(even),
        .payment-report-table tbody tr:nth-child(even) {
            background-color: var(--table-stripe);
        }
        /* Hover effect */
        .transactions-table tbody tr:hover,
        .members-table tbody tr:hover,
        .unpaid-table tbody tr:hover,
        .subjects-table tbody tr:hover,
        .payment-report-table tbody tr:hover {
            background-color: var(--table-hover);
        }

        .payment-report-table { min-width: 1000px; }
        .payment-report-table th:nth-child(1), .payment-report-table td:nth-child(1) { width: 60px; text-align: center; padding: 8px 4px; }
        .payment-report-table th:nth-child(2), .payment-report-table td:nth-child(2) { width: 160px; padding: 8px; }
        .payment-report-table th:nth-child(n+3), .payment-report-table td:nth-child(n+3) { width: 60px; text-align: center; white-space: nowrap; padding: 8px 2px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</h1>
                <div style="color: var(--text-muted); margin-top: 5px; font-weight: bold;">
                    Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <%= typeof adminName !== 'undefined' ? adminName : 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' %>
                </div>
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn btn-outline" onclick="toggleTheme()">ğŸŒ“ Ø§Ù„ÙˆØ¶Ø¹</button>
                <button onclick="showAddTransactionModal()" class="btn btn-success"><i class="fa-solid fa-plus"></i>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©</button>
                <a href="/jam3ya" class="btn btn-outline"><i class="fa-solid fa-eye"></i>Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
                <a href="/jam3ya/logout" class="btn btn-danger"><i class="fa-solid fa-right-from-bracket"></i>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
                <form method="POST" action="/jam3ya/reminders/send" style="display:inline;">
                    <button type="submit" class="btn btn-outline"><i class="fa-solid fa-envelope"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
                </form>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn" onclick="openTab('members')"><i class="fa-solid fa-users" style="margin-left:8px;"></i>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
            <button class="tab-btn active" onclick="openTab('transactions')"><i class="fa-solid fa-list" style="margin-left:8px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            <button class="tab-btn" onclick="openTab('subjects')"><i class="fa-solid fa-tags" style="margin-left:8px;"></i>Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹</button>
            <button class="tab-btn" onclick="openTab('unpaid')"><i class="fa-solid fa-clock" style="margin-left:8px;"></i>Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† Ø¹Ù† Ø§Ù„Ø¯ÙØ¹</button>
            <button class="tab-btn" onclick="openTab('paymentReport')"><i class="fa-solid fa-calendar-check" style="margin-left:8px;"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª</button>
            <button class="tab-btn" onclick="openTab('visitors')"><i class="fa-solid fa-globe" style="margin-left:8px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</button>
        </div>

        <!-- Members Tab -->
        <div id="members" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                <button class="btn btn-success" onclick="showAddMemberModal()">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</button>
            </div>
            <%
                const totalMembers = Array.isArray(members) ? members.length : 0;
                const emailCount = Array.isArray(members) ? members.filter(m => (m.email || '').trim() !== '').length : 0;
                const activeCount = Array.isArray(members) ? members.filter(m => (m.is_active == 1 || m.is_active == null)).length : 0;
                const inactiveCount = Array.isArray(members) ? members.filter(m => (m.is_active == 0)).length : 0;
            %>
            <div class="table-container" style="margin-bottom: 20px;">
                <h3 style="padding: 0 15px; margin-bottom: 10px; color: var(--primary);">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                <table style="min-width: auto; width: 100%;">
                    <thead>
                        <tr>
                            <th style="text-align: center; background: var(--table-header); color: var(--text);">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</th>
                            <th style="text-align: center; background: var(--table-header); color: var(--text);">Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                            <th style="text-align: center; background: var(--table-header); color: var(--text);">Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</th>
                            <th style="text-align: center; background: var(--table-header); color: var(--text);">ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: center; font-weight: bold;"><%= totalMembers %></td>
                            <td style="text-align: center; font-weight: bold;"><%= emailCount %></td>
                            <td style="text-align: center; font-weight: bold; color: var(--secondary);"><%= activeCount %></td>
                            <td style="text-align: center; font-weight: bold; color: var(--danger);"><%= inactiveCount %></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <% 
                const hasNotes = members && members.some(m => m.notes && m.notes !== '-' && m.notes.trim() !== '');
            %>
            <div class="table-container">
            <table class="table-fit members-table <%= !hasNotes ? 'compact' : '' %>">
                <thead>
                    <tr>
                        <th class="col-code sortable" onclick="sortMembers('code')">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶Ùˆ <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th class="col-nick sortable" onclick="sortMembers('nick')">Ø§Ù„Ù„Ù‚Ø¨ <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th class="col-name sortable" onclick="sortMembers('name')">Ø§Ù„Ø§Ø³Ù… <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th class="col-phone sortable" onclick="sortMembers('phone')">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th class="col-email sortable" onclick="sortMembers('email')">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th class="col-pass sortable" onclick="sortMembers('pass')">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th class="col-status sortable" onclick="sortMembers('status')">Ø§Ù„Ø­Ø§Ù„Ø© <i class="fa-solid fa-sort sort-icon"></i></th>
                        <% if (hasNotes) { %>
                        <th class="col-notes sortable" onclick="sortMembers('notes')">Ù…Ù„Ø§Ø­Ø¸Ø§Øª <i class="fa-solid fa-sort sort-icon"></i></th>
                        <% } %>
                        <th class="col-actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                    <tr>
                        <th class="col-code"><input id="filter_code" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <th class="col-nick"><input id="filter_nick" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <th class="col-name"><input id="filter_name" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <th class="col-phone"><input id="filter_phone" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <th class="col-email"><input id="filter_email" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <th class="col-pass"><input id="filter_pass" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <th class="col-status">
                            <select id="filter_status" onchange="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="active">Ù†Ø´Ø·</option>
                                <option value="inactive">Ù…Ø¹Ø·Ù„</option>
                            </select>
                        </th>
                        <% if (hasNotes) { %>
                        <th class="col-notes"><input id="filter_notes" type="text" placeholder="ØªØµÙÙŠØ©" oninput="filterMembers()" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;"></th>
                        <% } %>
                        <th class="col-actions"></th>
                    </tr>
                </thead>
                <tbody id="membersTableBody">
                    <% members.forEach(m => { %>
                    <tr>
                        <td class="col-code"><%= m.member_code %></td>
                        <td class="col-nick"><%= m.nickname || '-' %></td>
                        <td class="col-name">
                            <a href="#" onclick="showMemberHistory('<%= m.member_code %>'); return false;" style="color: var(--primary); text-decoration: none; font-weight: bold; border-bottom: 1px dashed var(--primary);">
                                <%= m.name %>
                            </a>
                        </td>
                        <td class="col-phone"><%= m.phone || '-' %></td>
                        <td class="col-email"><%= m.email || '-' %></td>
                        <td class="col-pass"><%= m.passcode || '-' %></td>
                        <td class="col-status">
                            <% if (m.is_active == 1 || m.is_active == null) { %>
                                <span class="badge success">Ù†Ø´Ø·</span>
                            <% } else { %>
                                <span class="badge danger">Ù…Ø¹Ø·Ù„</span>
                            <% } %>
                            <% if (m.is_admin == 1) { %>
                                <span class="badge" style="background: var(--purple);">Ù…Ø¯ÙŠØ±</span>
                            <% } %>
                        </td>
                        <% if (hasNotes) { %>
                        <td class="col-notes"><%= m.notes || '-' %></td>
                        <% } %>
                        <td class="col-actions">
                            <button class="btn btn-primary" onclick="editMember('<%= m.id %>', '<%= m.member_code %>', '<%= m.name %>', `<%= m.nickname || '' %>`, '<%= m.phone %>', '<%= m.email || '' %>', '<%= m.passcode %>', <%= m.is_active %>, <%= m.is_admin %>, `<%= m.notes || '' %>`)">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger" onclick="showDeleteConfirm('member','<%= m.id %>','Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ')">Ø­Ø°Ù</button>
                            <button class="btn btn-success" onclick="registerContributionForMember('<%= m.id %>')">ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø§Ù‡Ù…Ø©</button>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content active">
            
            <!-- Global Summary Table -->
            <div class="table-container" style="margin-bottom: 20px;">
                <h3 style="padding: 0 15px; margin-bottom: 10px; color: var(--primary);">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¬Ù…Ø¹ÙŠØ©</h3>
                <table style="min-width: auto; width: 100%;">
                    <thead>
                        <tr>
                            <th style="text-align: center; background: var(--bg-soft-primary); color: var(--primary);">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</th>
                            <th style="text-align: center; background: var(--bg-soft-success); color: var(--secondary);">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</th>
                            <th style="text-align: center; background: var(--bg-soft-danger); color: var(--danger);">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th>
                            <th style="text-align: center; background: var(--bg-soft-primary); color: var(--primary);">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: center; font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                                <%= mainData.initialBalance.toLocaleString('en-US') %> <small style="font-size: 0.8rem;">Ø±.Ø¹</small>
                            </td>
                            <td style="text-align: center; font-size: 1.2rem; font-weight: bold; color: var(--secondary);">
                                <%= mainData.totalIncome.toLocaleString('en-US') %> <small style="font-size: 0.8rem;">Ø±.Ø¹</small>
                            </td>
                            <td style="text-align: center; font-size: 1.2rem; font-weight: bold; color: var(--danger);">
                                <%= mainData.totalExpense.toLocaleString('en-US') %> <small style="font-size: 0.8rem;">Ø±.Ø¹</small>
                            </td>
                            <td style="text-align: center; font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                                <%= mainData.currentBalance.toLocaleString('en-US') %> <small style="font-size: 0.8rem;">Ø±.Ø¹</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="fa-solid fa-list" style="margin-left:8px;"></i>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                <button class="btn btn-success" onclick="showAddTransactionModal()"><i class="fa-solid fa-plus" style="margin-left:6px;"></i>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©</button>
            </div>
            <div class="export-actions">
                <button class="btn btn-success" onclick="exportWithChoice('excel')"><i class="fa-solid fa-file-excel"></i>ØªØµØ¯ÙŠØ± Ø§ÙƒØ³Ù„</button>
                <button class="btn btn-outline" onclick="exportWithChoice('pdf')"><i class="fa-solid fa-file-pdf"></i>ØªØµØ¯ÙŠØ± PDF</button>
            </div>
            <div class="table-container">
            <table class="transactions-table table-fit">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                        <th>Ø§Ù„Ø¨Ù†Ø¯ / Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</th>
                        <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</th>
                        <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    <% transactions.forEach(t => { %>
                    <tr>
                        <td style="font-weight: bold; color: var(--text-muted);"><%= t.id %></td>
                        <td><%= t.date ? new Date(t.date).toLocaleDateString('en-GB') : '-' %></td>
                        <td><%= t.subject %></td>
                        <td>
                            <% if (t.isMember) { %>
                                <a href="#" onclick="showMemberHistory('<%= t.item %>'); return false;" style="color: var(--primary); text-decoration: none; font-weight: bold; border-bottom: 1px dashed var(--primary);">
                                    <%= t.displayItem %> <span style="font-size: 0.8em; color: var(--text-muted);">(<%= t.item %>)</span>
                                </a>
                            <% } else { %>
                                <%= t.displayItem %>
                            <% } %>
                        </td>
                        <td dir="ltr" class="<%= t.amount >= 0 ? 'text-success' : 'text-danger' %>" style="text-align: right; font-weight: bold;">
                            <%= t.amount %>
                            <% if (t.is_approved === 0) { %>
                                <span class="badge bg-soft-warning" style="color: var(--text-warning); margin-right:8px;">Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>
                            <% } %>
                        </td>
                        <td dir="ltr" style="text-align: right; font-weight: bold; color: var(--primary);">
                            <%= t.balance %>
                        </td>
                        <td><%= t.details || '-' %></td>
                        <td>
                            <button class="btn btn-primary" onclick='editTransaction(<%- JSON.stringify(t) %>)' style="padding: 4px 8px; font-size: 0.8rem;">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger" onclick="showDeleteConfirm('transaction','<%= t.id %>','Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')" style="padding: 4px 8px; font-size: 0.8rem;">Ø­Ø°Ù</button>
                            <% if (t.is_approved === 0) { %>
                                <form action="/jam3ya/transactions/approve" method="POST" style="display:inline;">
                                    <input type="hidden" name="id" value="<%= t.id %>">
                                    <button class="btn btn-success" style="padding: 4px 8px; font-size: 0.8rem;">ØªØ£ÙƒÙŠØ¯</button>
                                </form>
                            <% } %>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Subjects Tab -->
        <div id="subjects" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹</h3>
                <button class="btn btn-success" onclick="showAddSubjectModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¶ÙˆØ¹</button>
            </div>
            <div class="table-container">
            <table class="table-fit subjects-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    <% subjects.forEach(s => { %>
                    <tr>
                        <td style="font-weight: bold; color: var(--text-muted);"><%= s.id %></td>
                        <td><%= s.name %></td>
                        <td>
                            <button class="btn btn-warning" onclick="editSubject('<%= s.id %>', '<%= s.name %>')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger" onclick="showDeleteConfirm('subject','<%= s.id %>','Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ØŸ Ø³ÙŠØ¸Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆÙ„ÙƒÙ† Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.')">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Unpaid Members Tab -->
        <div id="unpaid" class="tab-content">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</h3>
            
            <div style="background: var(--surface); padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px;">
                <h4>Ù†Ù…ÙˆØ°Ø¬ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h4>
                <div class="form-group">
                    <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø§Ø³ØªØ®Ø¯Ù… {{Ø§Ù„Ù„Ù‚Ø¨}} Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ù„Ù‚Ø¨ Ø§Ù„Ø¹Ø¶Ùˆ Ø£Ùˆ Ø§Ø³Ù…Ù‡ Ø§Ù„Ø£ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label>
                    <textarea id="whatsappTemplate" style="min-height: 150px; direction: rtl;">{{Ø§Ù„Ù„Ù‚Ø¨}} ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆÙ…Ø³Ø§Ø¡ Ø³Ø¹ÙŠØ¯ 
Ù†ÙˆØ¯ ØªØ°ÙƒÙŠØ±ÙƒÙ… Ø¨Ø¯ÙØ¹ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ù‡Ù„ÙŠØ© ÙˆØ§Ù„Ø¨Ø§Ù„ØºØ© 12 Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ 
Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ù† Ø·Ø±ÙŠÙ‚ 
Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 0361000959180037 - Ø¨Ù†Ùƒ Ù…Ø³Ù‚Ø· 
Ø§Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: 99464523 
 
Ø§Ø±Ø¬Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù† ÙƒÙ†Øª Ù‚Ø¯ Ø¯ÙØ¹Øª Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù… Ù…Ø¹ØªØ°Ø±ÙŠÙ† Ù…Ù†Ùƒ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ØºÙŠØ± Ù…Ù‚ØµÙˆØ¯.</textarea>
                </div>
                <button class="btn btn-primary" onclick="saveTemplate()">Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
            </div>

            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† Ø¹Ù† Ø§Ù„Ø¯ÙØ¹ (Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</h3>
            <div class="table-container">
            <table class="table-fit unpaid-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (typeof unpaidMembers !== 'undefined' && unpaidMembers.length > 0) { %>
                        <% unpaidMembers.forEach(m => { %>
                        <tr>
                            <td class="unpaid-name"><div class="primary-name"><%= m.name %></div></td>
                            <td><%= m.phone %></td>
                            <td>
                                <button class="btn btn-success" onclick="sendWhatsapp('<%= m.phone %>', `<%= m.nickname || '' %>`, `<%= m.name %>`)">
                                    Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
                                </button>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="3" style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…ØªØ£Ø®Ø±ÙŠÙ† Ø¹Ù† Ø§Ù„Ø¯ÙØ¹</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
            </div>
        </div>

    <!-- Export Mode Modal -->
    <div id="exportModeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØµØ¯ÙŠØ±</h3>
                <span class="close" onclick="closeModal('exportModeModal')">&times;</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" onclick="chooseExportMode('names')"><i class="fa-solid fa-user"></i> Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</button>
                <button class="btn btn-outline" onclick="chooseExportMode('codes')"><i class="fa-solid fa-hashtag"></i> Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Member Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</h3>
                <span class="close" onclick="closeModal('memberModal')">&times;</span>
            </div>
            <form action="/jam3ya/members/save" method="POST">
                <input type="hidden" name="id" id="memberId">
                <input type="hidden" name="member_code" id="memberCode">
                <div class="form-group" id="memberCodeDisplayGroup" style="display: none;">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶Ùˆ</label>
                    <div id="memberCodeDisplay" style="padding: 8px; background: var(--table-hover); border-radius: 4px;"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" name="name" id="memberName" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù„Ù‚Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠØ¸Ù‡Ø± ÙÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ù…Ø«Ø§Ù„: Ø£Ø¨Ùˆ ÙÙ‡Ø¯)</label>
                    <input type="text" name="nickname" id="memberNickname">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="text" name="phone" id="memberPhone">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" id="memberEmail">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                    <input type="text" name="passcode" id="memberPasscode">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" name="is_active" id="memberIsActive" checked>
                    <label for="memberIsActive" style="margin:0">Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" name="is_admin" id="memberIsAdmin">
                    <label for="memberIsAdmin" style="margin:0; color: var(--purple);">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… (Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ© Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)</label>
                </div>
                
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" id="memberNotes"></textarea>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <!-- Member History Modal -->
    <div id="memberHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="historyModalTitle">Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ</h3>
                <span class="close" onclick="closeModal('memberHistoryModal')">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 20px; background: var(--bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <div>
                    <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø§Øª:</strong>
                    <span id="historyTotalIncome" style="color: var(--secondary); font-weight: bold; font-size: 1.2rem;">0</span>
                </div>
                <div>
                    <strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ:</strong>
                    <span id="historyNetBalance" style="color: var(--primary); font-weight: bold; font-size: 1.2rem;">0</span>
                </div>
            </div>

            <div style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Payment Report Tab -->
    <div id="paymentReport" class="tab-content">
        <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª</h3>
        
        <!-- Summary Table for Yearly Totals -->
        <div class="table-container" style="margin-bottom: 20px;">
            <h4 style="padding: 0 15px; margin-bottom: 10px; margin-top: 10px; color: var(--primary);">Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø³Ù†ÙˆÙŠ</h4>
            <table style="min-width: auto; width: 100%;">
                <thead>
                    <tr>
                        <th style="text-align: center; background: var(--table-header); color: var(--text);">Ø§Ù„Ø³Ù†Ø©</th>
                        <th style="text-align: center; background: var(--table-header); color: var(--text);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody>
                    <% sortedYears.forEach(year => { 
                        const total = yearlyTotals[year] || 0;
                    %>
                        <tr>
                            <td style="text-align: center; font-weight: bold;"><%= year %></td>
                            <td style="text-align: center; color: var(--text-success-dark); font-weight: bold;"><%= total.toLocaleString('en-US') %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <table class="table-fit payment-report-table" id="paymentReportTable">
                <thead>
                    <tr>
                        <th onclick="sortPaymentReport(0)" style="cursor: pointer; width: 100px;">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶Ùˆ <i class="fa-solid fa-sort sort-icon"></i></th>
                        <th onclick="sortPaymentReport(1)" style="cursor: pointer; width: 250px;">Ø§Ù„Ø§Ø³Ù… <i class="fa-solid fa-sort sort-icon"></i></th>
                        <% sortedYears.forEach((year, idx) => { %>
                            <th onclick="sortPaymentReport(<%= idx + 2 %>)" style="cursor: pointer; text-align: center;"><%= year %> <i class="fa-solid fa-sort sort-icon"></i></th>
                        <% }) %>
                    </tr>
                </thead>
                <tbody>
                    <% members.forEach(m => { 
                        if (m.is_active == 0) return; // Skip inactive members
                    %>
                        <tr>
                            <td style="font-weight: bold; color: var(--text-muted); text-align: center;"><%= m.member_code %></td>
                            <td>
                                <a href="#" onclick="showMemberHistory('<%= m.member_code %>'); return false;" style="color: inherit; text-decoration: none; border-bottom: 1px dashed var(--text-muted);">
                                    <%= m.name %>
                                </a>
                            </td>
                            <% sortedYears.forEach(year => { 
                                const hasPaid = paymentReport[m.member_code] && paymentReport[m.member_code][year] !== undefined;
                                const amount = hasPaid ? paymentReport[m.member_code][year] : 0;
                            %>
                                <td class="<%= hasPaid ? 'bg-soft-success text-success-dark' : '' %>" style="text-align: center; font-weight: bold;">
                                    <%= hasPaid ? amount : '' %>
                                </td>
                            <% }) %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <div id="visitors" class="tab-content">
        <h3>Ø³Ø¬Ù„ Ø²ÙˆØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¢Ø®Ø± 200 Ø²ÙŠØ§Ø±Ø©)</h3>
        <div class="table-container" style="overflow-x: auto;">
            <table class="table-fit" style="width: 100%; min-width: 600px;">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th class="hide-on-mobile">Ø§Ù„ØµÙØ­Ø©</th>
                        <th class="hide-on-mobile">IP</th>
                        <th class="hide-on-mobile">Ø§Ù„Ù…ØªØµÙØ­</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (typeof visitors !== 'undefined' && visitors.length > 0) { %>
                        <% visitors.forEach((v, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td class="visitor-time" data-time="<%= v.date %>" style="direction: ltr; text-align: center; white-space: nowrap;"><%= v.date %></td>
                            <td style="font-weight: bold; color: var(--secondary); white-space: nowrap;"><%= v.member_name || '-' %></td>
                            <td class="hide-on-mobile" style="direction: ltr; text-align: left;"><%= v.path %></td>
                            <td class="hide-on-mobile"><%= v.ip %></td>
                            <td class="hide-on-mobile" style="font-size: 0.85rem; color: var(--text-muted);"><%= v.user_agent.substring(0, 30) %>...</td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø²ÙˆØ§Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        <style>
            @media (max-width: 768px) {
                .hide-on-mobile {
                    display: none;
                }
            }
        </style>
    </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var themeToggle = document.getElementById('themeToggle');
            var currentTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', currentTheme);
            window.toggleTheme = function() {
                var theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            };
            var cells = document.querySelectorAll('.visitor-time');
            cells.forEach(function(cell) {
                var raw = cell.getAttribute('data-time');
                if (!raw) return;
                var d;
                if (raw.endsWith('Z')) {
                    d = new Date(raw);
                } else if (raw.includes('T')) {
                    d = new Date(raw);
                } else {
                    d = new Date(raw.replace(' ', 'T'));
                }
                if (d && !isNaN(d.getTime())) {
                    cell.textContent = d.toLocaleDateString('en-GB') + ' ' + d.toLocaleTimeString('en-US');
                }
            });
        });
    </script>

    <!-- Add Subject Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¶ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h3>
                <span class="close" onclick="closeModal('subjectModal')">&times;</span>
            </div>
            <form action="/jam3ya/subjects/add" method="POST">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                    <input type="text" name="name" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%">Ø¥Ø¶Ø§ÙØ©</button>
            </form>
        </div>
    </div>

    <!-- Edit Subject Modal -->
    <div id="editSubjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¶ÙˆØ¹</h3>
                <span class="close" onclick="closeModal('editSubjectModal')">&times;</span>
            </div>
            <form action="/jam3ya/subjects/edit" method="POST">
                <input type="hidden" name="id" id="editSubjectId">
                <input type="hidden" name="old_name" id="editSubjectOldName">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                    <input type="text" name="name" id="editSubjectName" required>
                </div>
                <div class="bg-soft-warning" style="color: var(--text-warning); padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 4px;">
                    <small>ØªÙ†Ø¨ÙŠÙ‡: ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡ Ø£ÙŠØ¶Ø§Ù‹.</small>
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <span class="close" onclick="closeModal('confirmDeleteModal')">&times;</span>
            </div>
            <p id="confirmText" style="margin-bottom: 20px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <input type="hidden" id="deleteType">
            <input type="hidden" id="deleteId">
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-outline" onclick="closeModal('confirmDeleteModal')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-danger" onclick="confirmDeleteExecute()">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </div>
        </div>
    </div>

    <script>
        function showDeleteConfirm(type, id, message) {
            document.getElementById('deleteType').value = type;
            document.getElementById('deleteId').value = id;
            document.getElementById('confirmText').innerText = message || 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ';
            document.getElementById('confirmDeleteModal').style.display = 'flex';
        }

        function confirmDeleteExecute() {
            const type = document.getElementById('deleteType').value;
            const id = document.getElementById('deleteId').value;
            let action = '';
            if (type === 'transaction') action = '/jam3ya/transactions/delete';
            else if (type === 'member') action = '/jam3ya/members/delete';
            else if (type === 'subject') action = '/jam3ya/subjects/delete';
            if (!action || !id) return;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = action;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'id';
            input.value = id;
            form.appendChild(input);
            document.body.appendChild(form);
            document.getElementById('confirmDeleteModal').style.display = 'none';
            form.submit();
        }
        // Store members for lookup
        const membersList = <%- JSON.stringify(members) %>;
        // Store all transactions for client-side filtering
        const allTransactions = <%- JSON.stringify(transactions) %>;

        function showMemberHistory(code) {
            const member = membersList.find(m => m.member_code == code);
            const name = member ? member.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

            const modal = document.getElementById('memberHistoryModal');
            document.getElementById('historyModalTitle').innerText = 'Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª: ' + name;
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            let totalIncome = 0;
            let netBalance = 0;

            // Filter transactions for this member
            // Note: allTransactions is already sorted descending (processed in server)
            const memberTransactions = allTransactions.filter(t => t.item == code);

            if (memberTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ</td></tr>';
            } else {
                memberTransactions.forEach(t => {
                    // Calculate totals
                    if (t.amount > 0) {
                        totalIncome += t.amount;
                    }
                    netBalance += t.amount;

                    const tr = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    dateCell.innerText = t.date ? new Date(t.date).toLocaleDateString('en-GB') : '-';
                    tr.appendChild(dateCell);

                    const subjectCell = document.createElement('td');
                    subjectCell.innerText = t.subject;
                    tr.appendChild(subjectCell);

                    const amountCell = document.createElement('td');
                    amountCell.innerText = t.amount;
                    amountCell.dir = 'ltr';
                    amountCell.style.textAlign = 'right';
                    amountCell.style.fontWeight = 'bold';
                    amountCell.className = t.amount >= 0 ? 'text-success' : 'text-danger';
                    tr.appendChild(amountCell);

                    const detailsCell = document.createElement('td');
                    detailsCell.innerText = t.details || '-';
                    tr.appendChild(detailsCell);

                    tbody.appendChild(tr);
                });
            }

            document.getElementById('historyTotalIncome').innerText = totalIncome.toLocaleString('en-US') + ' Ø±.Ø¹';
            document.getElementById('historyNetBalance').innerText = netBalance.toLocaleString('en-US') + ' Ø±.Ø¹';

            modal.style.display = 'flex';
        }

        function selectSubject(val) {
            const select = document.getElementById('transaction_subject');
            select.value = val;
            toggleTransactionFields();
            
            // Visual feedback
            document.querySelectorAll('#quick-subjects .btn-outline').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText === val) btn.classList.add('active');
            });
        }

        function showSubjectDropdown() {
            document.getElementById('transaction_subject').style.display = 'block';
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            // Find the button that called this function and activate it
            // If called from onclick, event.target is the button (or icon inside)
            // If called programmatically, we might need to handle it.
            if (event && event.target) {
                // If click was on icon, get parent button
                let target = event.target;
                if (target.tagName === 'I') target = target.parentElement;
                target.classList.add('active');
            }
        }

        // Generic Table Sorting
        let currentSortColumn = -1;
        let isAscending = true;

        function sortPaymentReport(colIndex) {
            const table = document.getElementById('paymentReportTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            const th = table.querySelectorAll('th')[colIndex];

            // Toggle sort direction if clicking same column
            if (currentSortColumn === colIndex) {
                isAscending = !isAscending;
            } else {
                currentSortColumn = colIndex;
                isAscending = true;
            }

            // Update icons
            table.querySelectorAll('th i').forEach(icon => icon.className = 'fa-solid fa-sort sort-icon');
            const icon = th.querySelector('i');
            icon.className = isAscending ? 'fa-solid fa-sort-up sort-icon' : 'fa-solid fa-sort-down sort-icon';
            table.querySelectorAll('th').forEach(h => h.style.color = '');
            th.style.color = 'var(--secondary)';

            rows.sort((a, b) => {
                let cellA = a.cells[colIndex].innerText.trim();
                let cellB = b.cells[colIndex].innerText.trim();

                // Check if numeric
                const numA = parseFloat(cellA);
                const numB = parseFloat(cellB);

                if (!isNaN(numA) && !isNaN(numB) && cellA !== '' && cellB !== '') {
                    return isAscending ? numA - numB : numB - numA;
                } else {
                    return isAscending ? cellA.localeCompare(cellB, 'ar') : cellB.localeCompare(cellA, 'ar');
                }
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function showAddMemberModal() {
            document.getElementById('modalTitle').innerText = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('memberId').value = '';
            document.getElementById('memberCode').value = '';
            document.getElementById('memberCodeDisplayGroup').style.display = 'none';
            document.getElementById('memberName').value = '';
            document.getElementById('memberNickname').value = '';
            document.getElementById('memberPhone').value = '';
            document.getElementById('memberEmail').value = '';
            document.getElementById('memberPasscode').value = '';
            document.getElementById('memberIsActive').checked = true;
            document.getElementById('memberIsAdmin').checked = false;
            document.getElementById('memberNotes').value = '';
            document.getElementById('memberModal').style.display = 'flex';
        }

        function registerContributionForMember(memberId) {
            showAddTransactionModal();
            const incomeRadio = document.getElementById('type_income');
            const expenseRadio = document.getElementById('type_expense');
            if (incomeRadio) incomeRadio.checked = true;
            if (expenseRadio) expenseRadio.checked = false;
            
            const subjectSelect = document.getElementById('transaction_subject');
            if (subjectSelect) {
                // Ensure the subject exists in dropdown
                let hasMemberSubject = false;
                for (let i = 0; i < subjectSelect.options.length; i++) {
                    if (subjectSelect.options[i].value === 'Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡') { hasMemberSubject = true; break; }
                }
                if (!hasMemberSubject) {
                    const opt = document.createElement('option');
                    opt.value = 'Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡';
                    opt.text = 'Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡';
                    subjectSelect.appendChild(opt);
                }
                subjectSelect.value = 'Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡';
            }
            
            // Trigger field visibility for member contributions
            toggleTransactionFields();
            
            const memberInput = document.getElementById('transaction_member');
            if (memberInput) memberInput.value = String(memberId);
            
            const amountInput = document.querySelector('#addTransactionModal input[name="amount"]');
            const detailsInput = document.querySelector('#addTransactionModal textarea[name="details"]');
            if (amountInput) amountInput.value = 12;
            if (detailsInput) detailsInput.value = new Date().getFullYear();
        }

        function editMember(id, code, name, nickname, phone, email, passcode, isActive, isAdmin, notes) {
            document.getElementById('modalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¶Ùˆ';
            document.getElementById('memberId').value = id;
            document.getElementById('memberCode').value = code;
            document.getElementById('memberCodeDisplay').innerText = code;
            document.getElementById('memberCodeDisplayGroup').style.display = 'block';
            document.getElementById('memberName').value = name;
            document.getElementById('memberNickname').value = nickname;
            document.getElementById('memberPhone').value = phone;
            document.getElementById('memberEmail').value = email;
            document.getElementById('memberPasscode').value = passcode;
            document.getElementById('memberIsActive').checked = (isActive == 1 || isActive == null);
            document.getElementById('memberIsAdmin').checked = (isAdmin == 1);
            document.getElementById('memberNotes').value = notes;
            document.getElementById('memberModal').style.display = 'flex';
        }

        function saveTemplate() {
            const template = document.getElementById('whatsappTemplate').value;
            localStorage.setItem('jam3ya_whatsapp_template', template);
            alert('ØªÙ… Ø­ÙØ¸ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }

        function sendWhatsapp(phone, nickname, name) {
            let template = document.getElementById('whatsappTemplate').value;
            
            // If template is empty in textarea, try loading from local storage
            if (!template.trim()) {
                 template = localStorage.getItem('jam3ya_whatsapp_template') || document.getElementById('whatsappTemplate').value;
            }

            const honorific = nickname ? nickname : name.split(' ')[0];
            const message = template.replace('{{Ø§Ù„Ù„Ù‚Ø¨}}', honorific);
            
            // Format phone number: add 968 if not present
            let formattedPhone = phone.replace(/\D/g, ''); // Remove non-digits
            if (!formattedPhone.startsWith('968') && formattedPhone.length === 8) {
                formattedPhone = '968' + formattedPhone;
            }

            const encodedMessage = encodeURIComponent(message);
            
            const isMobile = /iPhone|Android|iPad|iPod/i.test(navigator.userAgent); 
            
            if (isMobile) { 
                // Using hidden anchor click to trigger deep link without leaving page context or opening blank tab
                const link = document.createElement('a');
                link.href = `whatsapp://send?phone=${formattedPhone}&text=${encodedMessage}`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else { 
                // Desktop: open web.whatsapp.com in new tab
                const url = `https://web.whatsapp.com/send?phone=${formattedPhone}&text=${encodedMessage}`; 
                window.open(url, '_blank');
            } 
        }

        function filterMembers() {
            const tbody = document.getElementById('membersTableBody');
            const codeVal = (document.getElementById('filter_code').value || '').trim().toLowerCase();
            const nickVal = (document.getElementById('filter_nick').value || '').trim().toLowerCase();
            const nameVal = (document.getElementById('filter_name').value || '').trim().toLowerCase();
            const phoneVal = (document.getElementById('filter_phone').value || '').trim().toLowerCase();
            const emailVal = (document.getElementById('filter_email').value || '').trim().toLowerCase();
            const passVal = (document.getElementById('filter_pass').value || '').trim().toLowerCase();
            const statusVal = document.getElementById('filter_status').value || '';
            const notesInput = document.getElementById('filter_notes');
            const notesVal = notesInput ? (notesInput.value || '').trim().toLowerCase() : '';
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const codeText = (cells[0] && cells[0].textContent || '').toLowerCase();
                const nickText = (cells[1] && cells[1].textContent || '').toLowerCase();
                const nameText = (cells[2] && cells[2].textContent || '').toLowerCase();
                const phoneText = (cells[3] && cells[3].textContent || '').toLowerCase();
                const emailText = (cells[4] && cells[4].textContent || '').toLowerCase();
                const passText = (cells[5] && cells[5].textContent || '').toLowerCase();
                const statusText = (cells[6] && cells[6].textContent || '');
                const notesText = notesInput ? ((cells[7] && cells[7].textContent || '').toLowerCase()) : '';
                const match =
                    (codeVal === '' || codeText.includes(codeVal)) &&
                    (nickVal === '' || nickText.includes(nickVal)) &&
                    (nameVal === '' || nameText.includes(nameVal)) &&
                    (phoneVal === '' || phoneText.includes(phoneVal)) &&
                    (emailVal === '' || emailText.includes(emailVal)) &&
                    (passVal === '' || passText.includes(passVal)) &&
                    (statusVal === '' || (statusVal === 'active' && statusText.includes('Ù†Ø´Ø·')) || (statusVal === 'inactive' && statusText.includes('Ù…Ø¹Ø·Ù„'))) &&
                    (!notesInput || notesVal === '' || notesText.includes(notesVal));
                row.style.display = match ? '' : 'none';
            });
        }
        const membersSortState = {};
        function sortMembers(field) {
            const ths = Array.from(document.querySelectorAll('.members-table th.sortable'));
            const clickedTh = ths.find(th => th.getAttribute('onclick') && th.getAttribute('onclick').includes("'" + field + "'")) || (event && event.target.closest('th'));
            const tbody = document.getElementById('membersTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const dir = membersSortState[field] === 'asc' ? 'desc' : 'asc';
            membersSortState[field] = dir;
            ths.forEach(th => {
                th.classList.remove('active');
                const ic = th.querySelector('.sort-icon');
                if (ic) { ic.classList.remove('fa-sort-up', 'fa-sort-down'); ic.classList.add('fa-sort'); }
            });
            if (clickedTh) {
                clickedTh.classList.add('active');
                const icon = clickedTh.querySelector('.sort-icon');
                if (icon) {
                    icon.classList.remove('fa-sort');
                    icon.classList.add(dir === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                }
            }
            function getVal(row, field) {
                if (field === 'code') return row.querySelector('.col-code') ? row.querySelector('.col-code').textContent.trim() : '';
                if (field === 'nick') return row.querySelector('.col-nick') ? row.querySelector('.col-nick').textContent.trim() : '';
                if (field === 'name') return row.querySelector('.col-name') ? row.querySelector('.col-name').textContent.trim() : '';
                if (field === 'phone') return row.querySelector('.col-phone') ? row.querySelector('.col-phone').textContent.trim() : '';
                if (field === 'email') return row.querySelector('.col-email') ? row.querySelector('.col-email').textContent.trim() : '';
                if (field === 'pass') return row.querySelector('.col-pass') ? row.querySelector('.col-pass').textContent.trim() : '';
                if (field === 'status') return row.querySelector('.col-status') ? row.querySelector('.col-status').textContent.trim() : '';
                if (field === 'notes') return row.querySelector('.col-notes') ? row.querySelector('.col-notes').textContent.trim() : '';
                return '';
            }
            rows.sort((a, b) => {
                let av = getVal(a, field);
                let bv = getVal(b, field);
                if (field === 'code') {
                    const an = parseInt(av, 10);
                    const bn = parseInt(bv, 10);
                    if (!isNaN(an) && !isNaN(bn)) return dir === 'asc' ? an - bn : bn - an;
                }
                return dir === 'asc' ? av.localeCompare(bv, 'ar', { sensitivity: 'base' }) : bv.localeCompare(av, 'ar', { sensitivity: 'base' });
            });
            rows.forEach(r => tbody.appendChild(r));
        }

        // Initialize template on load
        window.addEventListener('DOMContentLoaded', () => {
            const savedTemplate = localStorage.getItem('jam3ya_whatsapp_template');
            if (savedTemplate) {
                document.getElementById('whatsappTemplate').value = savedTemplate;
            }

            // Tab handling from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab) {
                // Try to find button with this tab name
                const tabBtn = document.querySelector(`.tab-btn[onclick*="'${tab}'"]`);
                if (tabBtn) {
                    openTab(tab);
                    // Manually activate button since openTab relies on event
                    setTimeout(() => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        tabBtn.classList.add('active');
                    }, 0);
                } else if (document.getElementById(tab)) {
                    openTab(tab);
                }
            }

            // Scroll restoration
            const scrollPos = sessionStorage.getItem('jam3ya_scroll_pos');
            if (scrollPos) {
                window.scrollTo(0, parseInt(scrollPos));
                sessionStorage.removeItem('jam3ya_scroll_pos'); 
            }
        });

        // Add listener to all forms to save scroll position
        // We use delegation or just attach to existing forms
        // Since some forms might be dynamic (created in JS), we should probably attach to document submit or just known forms.
        // But most forms are static.
        // Actually, the delete forms are created dynamically in JS.
        // So we should handle the submit event at the window level or attach to functions.
        
        // Better: Hook into the submit events.
        document.addEventListener('submit', function() {
            sessionStorage.setItem('jam3ya_scroll_pos', window.scrollY);
        });
        
        // Also for the dynamic forms created in confirmDelete functions
        const originalConfirmDelete = confirmDelete;
        confirmDelete = function(id) {
            sessionStorage.setItem('jam3ya_scroll_pos', window.scrollY);
            originalConfirmDelete(id);
        }

        const originalConfirmDeleteSubject = confirmDeleteSubject;
        confirmDeleteSubject = function(id) {
            sessionStorage.setItem('jam3ya_scroll_pos', window.scrollY);
            originalConfirmDeleteSubject(id);
        }

        const originalConfirmDeleteTransaction = confirmDeleteTransaction;
        confirmDeleteTransaction = function(id) {
            sessionStorage.setItem('jam3ya_scroll_pos', window.scrollY);
            originalConfirmDeleteTransaction(id);
        }

        function showAddSubjectModal() {
            document.getElementById('subjectModal').style.display = 'flex';
        }

        function editSubject(id, name) {
            document.getElementById('editSubjectId').value = id;
            document.getElementById('editSubjectOldName').value = name;
            document.getElementById('editSubjectName').value = name;
            document.getElementById('editSubjectModal').style.display = 'flex';
        }

        function confirmDeleteSubject(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ØŸ Ø³ÙŠØ¸Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆÙ„ÙƒÙ† Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/jam3ya/subjects/delete';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'id';
                input.value = id;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function confirmDelete(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/jam3ya/members/delete';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'id';
                input.value = id;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        function confirmDeleteTransaction(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/jam3ya/transactions/delete';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'id';
                input.value = id;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
        let currentExportType = null;
        function exportWithChoice(type) {
            currentExportType = type;
            document.getElementById('exportModeModal').style.display = 'flex';
        }
        function chooseExportMode(mode) {
            if (!currentExportType) return;
            const url = currentExportType === 'excel' ? ('/jam3ya/export/excel?mode=' + mode) : ('/jam3ya/export/pdf?mode=' + mode);
            document.getElementById('exportModeModal').style.display = 'none';
            window.location.href = url;
        }

        function showAddTransactionModal() {
            document.getElementById('addTransactionModal').style.display = 'flex';
            toggleTransactionFields();
        }

        function toggleTransactionFields() {
            const subjectSelect = document.getElementById('transaction_subject');
            const subject = subjectSelect.options[subjectSelect.selectedIndex].value;
            
            const memberField = document.getElementById('member_field');
            const descField = document.getElementById('description_field');
            const memberInput = document.getElementById('transaction_member');
            const descInput = document.getElementById('transaction_description');
            
            // Target specific inputs in the Add Modal
            const amountInput = document.querySelector('#addTransactionModal input[name="amount"]');
            const detailsInput = document.querySelector('#addTransactionModal textarea[name="details"]');

            // Check if subject is "Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡" (Member Contributions)
            if (subject === 'Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡') {
                memberField.style.display = 'block';
                descField.style.display = 'none';
                memberInput.required = true;
                descInput.required = false;
                if (!memberInput.value) descInput.value = ''; // Clear description only if empty
                
                // Set default values
                amountInput.value = 12;
                detailsInput.value = new Date().getFullYear();
            } else {
                memberField.style.display = 'none';
                descField.style.display = 'block';
                memberInput.required = false;
                descInput.required = true;
                memberInput.value = ''; // Clear member if switching to description
                
                // Clear defaults if they match the auto-set ones
                if (amountInput.value == 12) amountInput.value = '';
                if (detailsInput.value == new Date().getFullYear()) detailsInput.value = '';
            }
        }

        function toggleEditTransactionFields() {
            const subjectSelect = document.getElementById('edit_transaction_subject');
            const subject = subjectSelect.options[subjectSelect.selectedIndex].value;
            
            const memberField = document.getElementById('edit_member_field');
            const descField = document.getElementById('edit_description_field');
            const memberInput = document.getElementById('edit_transaction_member');
            const descInput = document.getElementById('edit_transaction_description');

            if (subject === 'Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡') {
                memberField.style.display = 'block';
                descField.style.display = 'none';
                memberInput.required = true;
                descInput.required = false;
            } else {
                memberField.style.display = 'none';
                descField.style.display = 'block';
                memberInput.required = false;
                descInput.required = true;
            }
        }

        function editTransaction(t) {
            document.getElementById('editTransactionModal').style.display = 'flex';
            
            // Set ID
            document.getElementById('edit_id').value = t.id;
            
            // Set Type
            if (t.amount >= 0) {
                document.getElementById('edit_type_income').checked = true;
            } else {
                document.getElementById('edit_type_expense').checked = true;
            }
            
            // Set Date
            if (t.date) {
                document.getElementById('edit_date').value = t.date.split('T')[0];
            }
            
            // Set Amount
            document.getElementById('edit_amount').value = Math.abs(t.amount);
            
            // Set Details
            document.getElementById('edit_details').value = t.details || '';
            
            // Set Subject
            const subjectSelect = document.getElementById('edit_transaction_subject');
            subjectSelect.value = t.subject;
            
            // Handle Item (Member vs Description)
            // We use the isMember flag we computed in the server
            const memberInput = document.getElementById('edit_transaction_member');
            const descInput = document.getElementById('edit_transaction_description');
            
            // Trigger toggle to set visibility based on subject
            toggleEditTransactionFields();
            
            if (t.isMember) {
                // Find member ID from code (t.item is code)
                const member = membersList.find(m => m.member_code === t.item);
                if (member) {
                    memberInput.value = member.id;
                }
            } else {
                descInput.value = t.item;
            }
        }
    </script>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©</h3>
                <span class="close" onclick="closeModal('addTransactionModal')">&times;</span>
            </div>
            <form action="/jam3ya/transactions/add" method="POST">
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                    <div class="checkbox-group">
                        <input type="radio" name="type" value="income" id="type_income" checked>
                        <label for="type_income">ÙˆØ§Ø±Ø¯ (Ù…Ø¯Ø®ÙˆÙ„ / Ù…Ø³Ø§Ù‡Ù…Ø©)</label>
                        <input type="radio" name="type" value="expense" id="type_expense">
                        <label for="type_expense">ØµØ§Ø¯Ø± (Ù…ØµØ±ÙˆÙ / ØªØ³Ù„ÙŠÙ…)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" name="date" required value="<%= new Date().toISOString().split('T')[0] %>">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ / Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                    
                    <!-- Quick Select Buttons -->
                    <div id="quick-subjects" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <% if (typeof activeSubjects !== 'undefined' && activeSubjects.length > 0) { %>
                            <% activeSubjects.forEach(sub => { %>
                                <button type="button" class="btn btn-outline" onclick="selectSubject('<%= sub %>')"><%= sub %></button>
                            <% }) %>
                        <% } %>
                        <button type="button" class="btn btn-primary" onclick="showSubjectDropdown()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„...</button>
                    </div>

                    <select name="subject" id="transaction_subject" required onchange="toggleTransactionFields()" style="<%= (typeof activeSubjects !== 'undefined' && activeSubjects.length > 0) ? 'display: none;' : '' %>">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ --</option>
                        <% subjects.forEach(s => { %>
                            <option value="<%= s.name %>"><%= s.name %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group" id="member_field">
                    <label>Ø§Ù„Ø¹Ø¶Ùˆ:</label>
                    <select name="member_id" id="transaction_member">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¶Ùˆ --</option>
                        <% members.forEach(m => { %>
                            <option value="<%= m.id %>"><%= m.name %> (<%= m.member_code %>)</option>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group" id="description_field" style="display: none;">
                    <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ (Ø§Ù„Ø¨Ù†Ø¯):</label>
                    <input type="text" name="description" id="transaction_description" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø´Ù‡Ø± 5">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹):</label>
                    <input type="number" step="0.001" name="amount" required placeholder="0.000">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ù…Ù„Ø§Ø­Ø¸Ø§Øª):</label>
                    <textarea name="details" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©</h3>
                <span class="close" onclick="closeModal('editTransactionModal')">&times;</span>
            </div>
            <form action="/jam3ya/transactions/edit" method="POST">
                <input type="hidden" name="id" id="edit_id">
                
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                    <div class="checkbox-group">
                        <input type="radio" name="type" value="income" id="edit_type_income">
                        <label for="edit_type_income">ÙˆØ§Ø±Ø¯ (Ù…Ø¯Ø®ÙˆÙ„ / Ù…Ø³Ø§Ù‡Ù…Ø©)</label>
                        <input type="radio" name="type" value="expense" id="edit_type_expense">
                        <label for="edit_type_expense">ØµØ§Ø¯Ø± (Ù…ØµØ±ÙˆÙ / ØªØ³Ù„ÙŠÙ…)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" name="date" id="edit_date" required>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ / Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                    <select name="subject" id="edit_transaction_subject" required onchange="toggleEditTransactionFields()">
                        <% subjects.forEach(s => { %>
                            <option value="<%= s.name %>"><%= s.name %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group" id="edit_member_field">
                    <label>Ø§Ù„Ø¹Ø¶Ùˆ:</label>
                    <select name="member_id" id="edit_transaction_member">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¶Ùˆ --</option>
                        <% members.forEach(m => { %>
                            <option value="<%= m.id %>"><%= m.name %> (<%= m.member_code %>)</option>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group" id="edit_description_field" style="display: none;">
                    <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ (Ø§Ù„Ø¨Ù†Ø¯):</label>
                    <input type="text" name="description" id="edit_transaction_description" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø´Ù‡Ø± 5">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹):</label>
                    <input type="number" step="0.001" name="amount" id="edit_amount" required placeholder="0.000">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ù…Ù„Ø§Ø­Ø¸Ø§Øª):</label>
                    <textarea name="details" id="edit_details" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </form>
        </div>
    </div>
    <style>
        @media (max-width: 768px) {
            .hide-on-mobile {
                display: none;
            }
        }
    </style>
</body>
</html>
